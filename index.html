<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grupo Exito Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel para transpilar JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { createRoot } = ReactDOM;

    // Componente para la página de inicio de sesión.
    const LoginPage = ({ onLogin }) => (
      <div className="flex flex-col items-center justify-center min-h-screen bg-gray-900 text-white">
        <div className="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-sm">
          <div className="flex justify-center mb-6">
            <img src="logo_brand_scope.png" alt="logo_brand_scope" className="h-[150px] w-[200px] rounded-xl" />
          </div>
          <h2 className="text-3xl font-bold mb-1 text-center text-teal-400">Grupo Exito</h2>
          <p className="text-center text-gray-500 text-sm">Todos los derechos reservados 2025</p>
          <p className="text-center mb-6 text-gray-500 text-xs">Registro de Patente Metoologica y operativa en proceso</p>
          <input
            type="text"
            placeholder="Usuario"
            className="w-full p-3 mb-4 rounded-xl bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-200"
          />
          <input
            type="password"
            placeholder="Contraseña"
            className="w-full p-3 mb-6 rounded-xl bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-200"
          />
          <button
            onClick={onLogin}
            className="w-full p-3 rounded-xl bg-teal-500 hover:bg-teal-600 transition duration-300 font-bold text-white shadow-lg"
          >
            Ingresar
          </button>
        </div>
      </div>
    );
    
    // Componente para los elementos de la barra lateral.
    const SidebarItem = ({ icon, text, isSelected, onClick }) => (
      <li className="mb-2">
        <button
          onClick={onClick}
          className={`flex items-center w-full p-3 rounded-xl transition duration-200 ${isSelected ? 'bg-teal-500 text-white shadow-lg' : 'hover:bg-gray-700 text-gray-300'}`}
        >
          {icon}
          <span className="ml-3 font-medium">{text}</span>
        </button>
      </li>
    );
    
    // Componente de la barra lateral (navegación).
    const Sidebar = ({ currentPage, setCurrentPage, onLogout, showMenu, setShowMenu }) => (
      <>
        {/* Fondo oscuro para el menú móvil */}
        {showMenu && <div className="fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden" onClick={() => setShowMenu(false)}></div>}
        
        <aside className={`fixed inset-y-0 left-0 transform ${showMenu ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 w-64 bg-gray-800 text-white p-6 flex flex-col transition-transform duration-300 ease-in-out z-50 md:z-auto rounded-r-2xl shadow-lg`}>
          <div className="flex items-center justify-between mb-8">
            <img src="https://placehold.co/150x50/111827/04D9FF?text=logo_brand_scope" alt="logo_brand_scope" className="h-10 w-auto" />
            <button onClick={() => setShowMenu(false)} className="text-white md:hidden">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <nav className="flex-1">
            <ul>
              <SidebarItem 
                icon={<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>} 
                text="Dashboard" 
                isSelected={currentPage === 'dashboard'} 
                onClick={() => setCurrentPage('dashboard')} 
              />
              <SidebarItem 
                icon={<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>} 
                text="Subir Excel" 
                isSelected={currentPage === 'upload'} 
                onClick={() => setCurrentPage('upload')} 
              />
              <SidebarItem 
                icon={<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>} 
                text="Análisis Reputacional" 
                isSelected={currentPage === 'analysis'} 
                onClick={() => setCurrentPage('analysis')} 
              />
              <SidebarItem 
                icon={<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><line x1="8" x2="16" y1="18" y2="18"/><line x1="8" x2="16" y1="14" y2="14"/></svg>} 
                text="Análisis Ejecutivo" 
                isSelected={currentPage === 'executive'} 
                onClick={() => setCurrentPage('executive')} 
              />
            </ul>
          </nav>
          <div className="mt-8">
            <button onClick={onLogout} className="flex items-center w-full p-3 rounded-xl text-red-400 hover:bg-gray-700 transition duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-3"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
              Cerrar sesión
            </button>
          </div>
        </aside>
      </>
    );

    // Componente del encabezado.
    const Header = ({ user, setShowMenu }) => (
      <header className="flex justify-between items-center bg-white p-4 rounded-2xl shadow-md mb-6">
        <div className="flex items-center">
          <button onClick={() => setShowMenu(true)} className="text-gray-600 md:hidden mr-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
          </button>
          <h1 className="text-2xl font-bold">Bienvenido, {user.name}</h1>
        </div>
        <div className="flex items-center">
          <span className="text-gray-500 text-sm">Versión 1.0</span>
        </div>
      </header>
    );

    // Tarjeta de estadísticas para el dashboard.
    const StatCard = ({ title, value, color }) => (
      <div className={`p-6 rounded-2xl shadow-md text-white transform transition-transform duration-300 hover:scale-105 ${color}`}>
        <h4 className="text-lg font-semibold mb-2">{title}</h4>
        <p className="text-4xl font-bold">{value}</p>
      </div>
    );
    
    // Componente para subir archivos.
    const UploadContent = () => (
      <div className="bg-white p-6 rounded-2xl shadow-md">
        <h2 className="text-3xl font-bold text-gray-800 mb-6">Subir Archivo de Menciones</h2>
        <div className="border-4 border-dashed border-gray-300 p-12 rounded-2xl text-center mb-6">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mx-auto text-gray-400 mb-4"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>
          <p className="text-gray-600">Arrastra y suelta tu archivo Excel aquí o</p>
          <label htmlFor="file-upload" className="cursor-pointer font-bold text-teal-500 hover:text-teal-600 transition duration-200">
            selecciona un archivo
          </label>
          <input id="file-upload" type="file" className="hidden" />
        </div>
        <div className="bg-gray-100 p-4 rounded-xl text-gray-700">
          <p className="font-semibold mb-2">Columnas del archivo:</p>
          <ul className="list-disc list-inside space-y-1">
            <li>`id`</li>
            <li>`comentario`</li>
            <li>`tipo`</li>
            <li>`impresiones`</li>
            <li>`alcance`</li>
            <li>`impacto`</li>
            <li>`replies`</li>
            <li>`engagement`</li>
            <li>`impacto`</li>
            <li>`usuario`</li>
          </ul>
        </div>
      </div>
    );
    
    // Contenido del análisis reputacional.
    const AnalysisContent = () => (
      <div className="bg-white p-6 rounded-2xl shadow-md">
        <h2 className="text-3xl font-bold text-gray-800 mb-6">Análisis Reputacional</h2>
        <div className="space-y-6">
          <div>
            <h3 className="text-xl font-semibold mb-2">Brechas por Dimensión</h3>
            <p className="text-gray-600">Aquí se mostrarían las brechas comunicacionales identificadas para cada dimensión.</p>
            <div className="h-48 bg-gray-50 rounded-xl flex items-center justify-center text-gray-400 mt-2">
              Tabla/gráfico de brechas (Mock)
            </div>
          </div>
          <div>
            <h3 className="text-xl font-semibold mb-2">Evolución Reputacional por Dimensión</h3>
            <p className="text-gray-600">Gráfico de velas japonesas para la reputación de cada dimensión a lo largo del tiempo.</p>
            <div className="h-48 bg-gray-50 rounded-xl flex items-center justify-center bg-gray-50 rounded-xl text-gray-400 mt-2">
              Gráfico de velas por dimensión (Mock)
            </div>
          </div>
        </div>
      </div>
    );
    
    // Contenido del análisis ejecutivo.
    const ExecutiveAnalysisContent = () => {
      const [executiveSummary, setExecutiveSummary] = useState(null);
    
      useEffect(() => {
        // Aquí iría la llamada a la API de N8N para obtener el análisis ejecutivo
        const fetchExecutiveSummary = async () => {
          try {
            // const response = await fetch('https://your-n8n-api-url/executive-summary');
            // const data = await response.json();
            // setExecutiveSummary(data);
            console.log("Simulando la carga del resumen ejecutivo...");
            // Si hay un error o no se tienen datos, se usa el mock de ejemplo
            setExecutiveSummary({
              analysis: "Basado en las menciones procesadas y los gráficos de brechas y evolución, se ha identificado un rendimiento mixto. Aunque la reputación general se mantiene estable, se observan puntos críticos en la dimensión de 'Conducta'.",
              recommendations: [
                {
                  dimension: "Conducta",
                  points: [
                    "Aspectos Semánticos: Mejorar la proactividad en la comunicación de políticas internas, utilizando un lenguaje más empático y cercano. Evitar frases corporativas que generen desconfianza.",
                    "Mensajes Clave: Crear mensajes que refuercen la transparencia y el compromiso con los clientes. Estructura: [Heurística: Reconocimiento del problema] + [Acción Correctiva] + [Compromiso a futuro].",
                    "Estrategias: Implementar un plan de comunicación de crisis que incluya la monitorización en tiempo real y la formación de portavoces para una respuesta rápida y coherente."
                  ]
                }
              ]
            });
          } catch (error) {
            console.error("Error fetching executive summary:", error);
          }
        };
    
        fetchExecutiveSummary();
      }, []);
    
      if (!executiveSummary) {
        return (
          <div className="bg-white p-6 rounded-2xl shadow-md flex items-center justify-center h-96">
            <svg className="animate-spin h-8 w-8 text-teal-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p className="ml-3 text-gray-500">Generando análisis ejecutivo...</p>
          </div>
        );
      }
    
      return (
        <div className="bg-white p-6 rounded-2xl shadow-md">
          <h2 className="text-3xl font-bold text-gray-800 mb-6">Análisis Ejecutivo y Recomendaciones</h2>
          <div className="space-y-6 text-gray-700">
            <div>
              <h3 className="text-xl font-semibold mb-2">Análisis Reputacional</h3>
              <p>{executiveSummary.analysis}</p>
            </div>
            <div>
              <h3 className="text-xl font-semibold mb-2">Recomendaciones por Dimensión</h3>
              {executiveSummary.recommendations.map((rec, index) => (
                <div key={index} className="bg-gray-100 p-4 rounded-xl mb-4">
                  <h4 className="font-bold text-lg mb-2">Dimensión: {rec.dimension}</h4>
                  <ol className="list-decimal list-inside space-y-2 text-gray-600">
                    {rec.points.map((point, i) => (
                      <li key={i} dangerouslySetInnerHTML={{ __html: point.replace("Aspectos Semánticos:", "<b>Aspectos Semánticos:</b>").replace("Mensajes Clave:", "<b>Mensajes Clave:</b>").replace("Estrategias:", "<b>Estrategias:</b>") }}></li>
                    ))}
                  </ol>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // Contenido del dashboard principal.
    const DashboardContent = ({ mentions, processMentions, isLoading, reptrackData }) => {
      // Usamos un useRef para el canvas del gráfico
      const chartRef = useRef(null);

      // Usamos useEffect para inicializar el gráfico cuando los datos estén listos
      useEffect(() => {
        // Verificamos que tengamos una referencia al canvas y datos
        if (chartRef.current && reptrackData.labels) {
          // Destruimos cualquier instancia de gráfico existente para evitar duplicados
          if (chartRef.current.chart) {
            chartRef.current.chart.destroy();
          }

          // Creamos una nueva instancia de gráfico de Chart.js
          const ctx = chartRef.current.getContext('2d');
          chartRef.current.chart = new Chart(ctx, {
            type: 'polarArea',
            data: reptrackData,
            options: {
              responsive: true,
              maintainAspectRatio: false,
            }
          });
        }
      }, [reptrackData]); // El efecto se ejecuta cuando los datos de reptrack cambian
      
      return (
        <div className="space-y-8">
          <h2 className="text-3xl font-bold text-gray-800">Estado de Reputación</h2>
          <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
            <StatCard title="Menciones Pendientes" value={mentions.pending} color="bg-orange-500" />
            <StatCard title="Menciones Procesadas" value={mentions.processed} color="bg-teal-500" />
            <StatCard title="Total Menciones" value={mentions.pending + mentions.processed} color="bg-blue-500" />
            <StatCard title="Porcentaje Procesado" value={`${((mentions.processed / (mentions.pending + mentions.processed)) * 100).toFixed(1)}%`} color="bg-purple-500" />
          </div>
      
          <div className="bg-white p-6 rounded-2xl shadow-md">
            <h3 className="text-xl font-semibold mb-4">Control de Procesamiento</h3>
            <p className="text-gray-600 mb-4">
              Haz clic en el botón para agarrar una muestra de las menciones pendientes y comenzar el flujo de clasificación.
            </p>
            <button
              onClick={processMentions}
              className={`p-3 rounded-xl text-white font-bold transition duration-300 ${
                isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600'
              }`}
              disabled={isLoading}
            >
              {isLoading ? (
                <span className="flex items-center">
                  <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Procesando...
                </span>
              ) : 'Procesar Muestra'}
            </button>
          </div>
      
          <div className="grid md:grid-cols-2 gap-6">
            <div className="bg-white p-6 rounded-2xl shadow-md">
              <h3 className="text-xl font-semibold mb-4">Evolución Reputacional (Velas Japonesas)</h3>
              <div className="h-64 flex items-center justify-center bg-gray-50 rounded-xl text-gray-400">
                Gráfico de Velas (Mock)
              </div>
            </div>
            <div className="bg-white p-6 rounded-2xl shadow-md">
              <h3 className="text-xl font-semibold mb-4">ReptrackWheel Consolidado</h3>
              {/* Usamos un canvas en lugar del componente de React */}
              {reptrackData.labels && reptrackData.datasets ? (
                <div className="h-64">
                  <canvas ref={chartRef} />
                </div>
              ) : (
                <div className="h-64 flex items-center justify-center bg-gray-50 rounded-xl text-gray-400">
                  Gráfico ReptrackWheel (Mock)
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };
    
    // Componente principal de la aplicación.
    const App = () => {
      const [user, setUser] = useState(null);
      const [currentPage, setCurrentPage] = useState('dashboard');
      const [mentions, setMentions] = useState({ pending: 1500, processed: 850 });
      const [isLoading, setIsLoading] = useState(false);
      const [showMenu, setShowMenu] = useState(false);
      const [reptrackData, setReptrackData] = useState({
        labels: ['Calidad', 'Integridad', 'Innovación', 'Responsabilidad', 'Desempeño', 'Liderazgo'],
        datasets: [{
          data: [80, 75, 90, 85, 70, 95],
          backgroundColor: [
            'rgba(255, 99, 132, 0.5)',
            'rgba(54, 162, 235, 0.5)',
            'rgba(255, 206, 86, 0.5)',
            'rgba(75, 192, 192, 0.5)',
            'rgba(153, 102, 255, 0.5)',
            'rgba(255, 159, 64, 0.5)'
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)'
          ],
          borderWidth: 1,
        }],
      });
    
      useEffect(() => {
        // Al cargar la página, se obtienen los datos iniciales
        if (user) {
          fetchDashboardData();
        }
      }, [user]);
    
      // Función para obtener los datos del dashboard desde la API de N8N
      const fetchDashboardData = async () => {
        try {
          // Esta es una simulación. En un caso real, la URL sería tu endpoint de N8N.
          // const response = await fetch('https://your-n8n-api-url/dashboard-data');
          // const data = await response.json();
          // setMentions({ pending: data.pending, processed: data.processed });
          // setReptrackData(data.reptrackData);
          console.log("Simulando la carga de datos del dashboard...");
        } catch (error) {
          console.error("Error fetching dashboard data:", error);
        }
      };
    
      // Simulación de autenticación.
      const handleLogin = () => {
        // Aquí iría una llamada a la API de N8N para autenticar al usuario
        // Si la autenticación es exitosa, se establece el usuario
        setUser({ name: 'Usuario' });
      };
    
      const handleLogout = () => {
        setUser(null);
      };
    
      // Función para procesar menciones usando la API de N8N
      const processMentions = async () => {
        setIsLoading(true);
        try {
          // await fetch('https://your-n8n-api-url/process-mentions', {
          //   method: 'POST',
          //   headers: {
          //     'Content-Type': 'application/json',
          //   },
          //   body: JSON.stringify({ sampleSize: 200 }),
          // });
          // Después de procesar, se vuelven a obtener los datos del dashboard para actualizar
          // await fetchDashboardData();
          console.log("Simulando el procesamiento de menciones...");
          setTimeout(() => {
            setMentions(prev => ({
              ...prev,
              pending: Math.max(0, prev.pending - 200),
              processed: prev.processed + 200
            }));
            setIsLoading(false);
          }, 2000);
        } catch (error) {
            console.error("Error processing mentions:", error);
        } finally {
            setIsLoading(false);
        }
      };
    
      if (!user) {
        return <LoginPage onLogin={handleLogin} />;
      }
    
      return (
        <div className="flex min-h-screen bg-gray-100 font-sans text-gray-800">
          <Sidebar currentPage={currentPage} setCurrentPage={setCurrentPage} onLogout={handleLogout} showMenu={showMenu} setShowMenu={setShowMenu} />
          <div className="flex-1 flex flex-col p-4 md:p-8">
            <Header user={user} showMenu={showMenu} setShowMenu={setShowMenu} />
            <main className="flex-1 mt-6">
              {currentPage === 'dashboard' && <DashboardContent mentions={mentions} processMentions={processMentions} isLoading={isLoading} reptrackData={reptrackData} />}
              {currentPage === 'upload' && <UploadContent />}
              {currentPage === 'analysis' && <AnalysisContent />}
              {currentPage === 'executive' && <ExecutiveAnalysisContent />}
            </main>
          </div>
        </div>
      );
    };

    // Renderiza la aplicación en el DOM
    window.onload = () => {
      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    };
  </script>
</body>
</html>
